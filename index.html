<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë³„ë‚œë³„ íƒ€ë¡œì¹´ë“œ</title>
 
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(120deg, #2d1b69 0%, #e9dbf2 100%);
      font-family: 'Arial', sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      flex-direction: column;
    }

    .container {
      max-width: 900px;
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }

    h1 {
      color: white;
      margin-bottom: 30px;
    }

    .tarot-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .card {
      width: 200px;
      height: 300px;
      perspective: 1000px;
      cursor: pointer;
    }

    .card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
    }

    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }

    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 8px;
      overflow: hidden;
    }

    .card-front img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .card-back {
      background-color: #2d2a4a;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      font-size: 12.5px;
      line-height: 1.4;
      white-space: pre-line;
      box-sizing: border-box;
      transform: rotateY(180deg) scale(0.95);
      text-align: center;
      box-shadow: 0 0 20px 8px rgba(255, 255, 255, 0.2), 0 0 30px 14px rgba(255, 255, 255, 0.1) inset;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .sub-button {
      background-color: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 14px;
      cursor: pointer;
      backdrop-filter: blur(6px);
      transition: all 0.3s ease;
    }

    .sub-button:hover {
      background-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 10px 3px #fff;
      transform: translateY(-1px);
    }

    /* ê³µìœ ìš© ìº”ë²„ìŠ¤ëŠ” í™”ë©´ì—ì„œ ìˆ¨ê¹€ */
    #shareCanvas {
      position: absolute;
      left: -9999px;
      top: -9999px;
    }


  </style>
</head>
<body>
  <div class="container">
    <h1>âœ¨ ë³„ë‚œë³„ íƒ€ë¡œì¹´ë“œ âœ¨</h1> <br> 

    <div class="tarot-container">
      <div class="card" onclick="flipCard(this, 'ì¹´ë“œ1')" data-message="ìƒˆë¡œìš´ ì¸ì—°ì´ ë‹¤ê°€ì˜µë‹ˆë‹¤.&#10;ë§ˆìŒì„ ì—´ê³  ê¸°ë‹¤ë ¤ë³´ì„¸ìš”." data-image="https://i.imgur.com/HRZrNvm.png">
        <div class="card-inner">
          <div class="card-front">
            <img src="https://i.imgur.com/HRZrNvm.png" alt="ì¹´ë“œ1 ì•ë©´">
          </div>
          <div class="card-back">
            ìƒˆë¡œìš´ ì¸ì—°ì´ ë‹¤ê°€ì˜µë‹ˆë‹¤.
            ë§ˆìŒì„ ì—´ê³  ê¸°ë‹¤ë ¤ë³´ì„¸ìš”.
          </div>
        </div>
      </div>
      <div class="card" onclick="flipCard(this, 'ì¹´ë“œ2')" data-message="í–‰ìš´ì§€ìˆ˜ê°€ ìƒìŠ¹í•˜ì˜€ìŠµë‹ˆë‹¤!&#10;ì˜ˆìƒì¹˜ ëª»í–ˆë˜ ìˆ˜ì…ì´ ë“¤ì–´ì˜¬ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤." data-image="https://i.imgur.com/NMbruAt.png">
        <div class="card-inner">
          <div class="card-front">
            <img src="https://i.imgur.com/NMbruAt.png" alt="ì¹´ë“œ2 ì•ë©´">
          </div>
          <div class="card-back">
            í–‰ìš´ì§€ìˆ˜ê°€ ìƒìŠ¹í•˜ì˜€ìŠµë‹ˆë‹¤!
            ì˜ˆìƒì¹˜ ëª»í–ˆë˜ ìˆ˜ì…ì´ ë“¤ì–´ì˜¬ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
      <div class="card" onclick="flipCard(this, 'ì¹´ë“œ3')" data-message="ë°œ ë°‘ë§Œ ë³´ë©° ê±·ë‹¤ë³´ë©´ ì˜ˆìƒì¹˜ ëª»í•œ ê¸¸ë¡œ ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.&#10;ë©€ë¦¬ ë³´ê³  ì§„í–‰í•˜ì‹œê¸¸!" data-image="https://i.imgur.com/OZB4t3N.png">
        <div class="card-inner">
          <div class="card-front">
            <img src="https://i.imgur.com/OZB4t3N.png" alt="ì¹´ë“œ3 ì•ë©´">
          </div>
          <div class="card-back">
            ë°œ ë°‘ë§Œ ë³´ë©° ê±·ë‹¤ë³´ë©´ ì˜ˆìƒì¹˜ ëª»í•œ ê¸¸ë¡œ ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            ë©€ë¦¬ ë³´ê³  ì§„í–‰í•˜ì‹œê¸¸!
          </div>
        </div>
      </div>
    </div>

    <div class="buttons">
      <button class="sub-button" onclick="goToStart()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
      <button class="sub-button" onclick="sharePage()">ğŸ“¤ ê³µìœ í•˜ê¸°</button>
    </div>
  </div>

  <!-- ê³µìœ ìš© ì´ë¯¸ì§€ ìƒì„±ì„ ìœ„í•œ ìˆ¨ê²¨ì§„ ìº”ë²„ìŠ¤ (ì¹´ë“œ ë¹„ìœ¨) -->
  <canvas id="shareCanvas" width="600" height="900"></canvas>

  <script>
    // í–‰ë™ ë¡œê¹… API URL
    const BEHAVIOR_LOG_URL = 'https://script.google.com/macros/s/AKfycbxtMKTALtx6IWOwsuy9q2TmKRCH3A61xWsaYbkT9OuTEjb9tCraWr5mfnq_slLgxIt29Q/exec';
    
    let selectedCard = null;
    let selectedCardData = null;
    let hasSelectedCard = false;
    let selectedCardName = '';

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸
    document.addEventListener('DOMContentLoaded', function() {
      sendBehaviorLog('í˜ì´ì§€_ë°©ë¬¸');
    });

    function flipCard(card, cardName) {
      const isFlipped = card.classList.contains('flipped');

      if (!selectedCard) {
        card.classList.toggle('flipped');
        selectedCard = card;
        selectedCardData = {
          message: card.dataset.message.replace(/&#10;/g, '\n'),
          image: card.dataset.image
        };
        hasSelectedCard = true;
        selectedCardName = cardName;
        disableOtherCards(card);
        
        // ì¹´ë“œ ì„ íƒ ë¡œê·¸
        sendBehaviorLog('ì¹´ë“œ_ì„ íƒ');
      } else if (card === selectedCard) {
        card.classList.toggle('flipped');
      } else {
        alert("í•˜ë£¨ì— í•œ ë²ˆë§Œ ë½‘ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!\në‹¤ì‹œ ë½‘ê³  ì‹¶ìœ¼ì‹œë‹¤ë©´, ì²˜ìŒìœ¼ë¡œ ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”!");
      }
    }

    function disableOtherCards(exceptCard) {
      document.querySelectorAll('.card').forEach(card => {
        if (card !== exceptCard) {
          card.onclick = () => {
            alert("í•˜ë£¨ì— í•œ ë²ˆë§Œ ë½‘ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ë½‘ê³  ì‹¶ìœ¼ì‹œë‹¤ë©´, ì²˜ìŒìœ¼ë¡œ ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”!");
          };
        }
      });
    }

    function goToStart() {
      sendBehaviorLog('ì²˜ìŒìœ¼ë¡œ_ë²„íŠ¼_í´ë¦­');
      setTimeout(() => {
        window.location.href = "https://kimjiwoow.github.io/-/";
      }, 500);
    }

    // ë¡œê·¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
    function testLog() {
      updateLogStatus('í…ŒìŠ¤íŠ¸ ì‹œì‘...');
      sendBehaviorLog('í…ŒìŠ¤íŠ¸_ë²„íŠ¼_í´ë¦­');
    }

    // ë¡œê·¸ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateLogStatus(message) {
      const logStatus = document.getElementById('logStatus');
      logStatus.textContent = `ë¡œê·¸ ìƒíƒœ: ${message}`;
      logStatus.style.color = message.includes('ì„±ê³µ') ? 'green' : 
                           message.includes('ì‹¤íŒ¨') ? 'red' : 'black';
    }

    async function createShareImage() {
      if (!selectedCardData) return null;

      const canvas = document.getElementById('shareCanvas');
      const ctx = canvas.getContext('2d');
      
      // ê³ í™”ì§ˆ ì„¤ì •
      const pixelRatio = window.devicePixelRatio || 1;
      canvas.width = 600 * pixelRatio;
      canvas.height = 900 * pixelRatio;
      ctx.scale(pixelRatio, pixelRatio);
      
      // íˆ¬ëª… ë°°ê²½ (ë°°ê²½ ì—†ìŒ)
      ctx.clearRect(0, 0, 600, 900);

      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function() {
          // ì¹´ë“œ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ìƒë‹¨ì— ë°°ì¹˜)
          const cardX = 50;
          const cardY = 50;
          const cardWidth = 500;
          const cardHeight = 600;
          
          ctx.drawImage(img, cardX, cardY, cardWidth, cardHeight);

          // ë©”ì‹œì§€ ë°•ìŠ¤ (ì¹´ë“œ ì•„ë˜)
          const msgX = 50;
          const msgY = 680;
          const msgWidth = 500;
          const msgHeight = 170;
          
          // ë©”ì‹œì§€ ë°°ê²½ (ë°˜íˆ¬ëª… í°ìƒ‰)
          ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
          ctx.fillRect(msgX, msgY, msgWidth, msgHeight);
          
          // ë©”ì‹œì§€ í…Œë‘ë¦¬
          ctx.strokeStyle = '#2d1b69';
          ctx.lineWidth = 3;
          ctx.strokeRect(msgX, msgY, msgWidth, msgHeight);

          // ë©”ì‹œì§€ í…ìŠ¤íŠ¸
          ctx.fillStyle = '#2d1b69';
          ctx.font = 'bold 28px Arial';
          ctx.textAlign = 'center';
          
          const lines = selectedCardData.message.split('\n');
          const lineHeight = 40;
          const startY = 720;
          
          lines.forEach((line, index) => {
            ctx.fillText(line, 300, startY + (index * lineHeight));
          });

          // í•˜ë‹¨ ë¡œê³ /í…ìŠ¤íŠ¸ (ì‘ê²Œ)
          ctx.font = '20px Arial';
          ctx.fillStyle = '#666666';
          ctx.fillText('âœ¨ ë³„ë‚œë³„ íƒ€ë¡œì¹´ë“œ âœ¨', 300, 820);

          resolve(canvas.toDataURL('image/png', 1.0));
        };
        img.src = selectedCardData.image;
      });
    }

    // êµ¬ì‹ ë¸Œë¼ìš°ì €ìš© í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜
    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      
      textArea.style.position = "fixed";
      textArea.style.top = "-1000px";
      textArea.style.left = "-1000px";
      textArea.style.width = "2em";
      textArea.style.height = "2em";
      textArea.style.padding = "0";
      textArea.style.border = "none";
      textArea.style.outline = "none";
      textArea.style.boxShadow = "none";
      textArea.style.background = "transparent";
      
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        return successful;
      } catch (err) {
        document.body.removeChild(textArea);
        return false;
      }
    }

    async function copyToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (err) {
          console.log('navigator.clipboard ì‹¤íŒ¨, fallback ì‹œë„');
          return fallbackCopyTextToClipboard(text);
        }
      } else {
        return fallbackCopyTextToClipboard(text);
      }
    }

    async function sharePage() {
      if (!selectedCardData) {
        alert('ë¨¼ì € ì¹´ë“œë¥¼ ë½‘ì•„ì£¼ì„¸ìš”!');
        return;
      }

      sendBehaviorLog('ê³µìœ í•˜ê¸°_ë²„íŠ¼_í´ë¦­');

      const shareText = `âœ¨ ë³„ë‚œë³„ íƒ€ë¡œì¹´ë“œ âœ¨\n\nì˜¤ëŠ˜ì˜ ìš´ì„¸:\n${selectedCardData.message}\n\në‹¹ì‹ ë„ ìš´ì„¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!\n https://kimjiwoow.github.io/-/`;

      try {
        const shareImageUrl = await createShareImage();
        
        if (navigator.share && /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
          try {
            const response = await fetch(shareImageUrl);
            const blob = await response.blob();
            const file = new File([blob], 'tarot-result.png', { type: 'image/png' });
            
            await navigator.share({
              title: 'ë³„ë‚œë³„ íƒ€ë¡œì¹´ë“œ',
              text: shareText,
              files: [file]
            });
            sendBehaviorLog('ê³µìœ _ì„±ê³µ_ëª¨ë°”ì¼ì›¹ê³µìœ ');
            return;
          } catch (error) {
            try {
              await navigator.share({
                title: 'ë³„ë‚œë³„ íƒ€ë¡œì¹´ë“œ',
                text: shareText
              });
              sendBehaviorLog('ê³µìœ _ì„±ê³µ_ëª¨ë°”ì¼í…ìŠ¤íŠ¸ê³µìœ ');
              return;
            } catch (textShareError) {
              console.log('ì›¹ ê³µìœ  API ì‹¤íŒ¨, í´ë¦½ë³´ë“œ ë³µì‚¬ë¡œ ì „í™˜');
            }
          }
        }
        
        const copySuccess = await copyToClipboard(shareText);
        
        if (copySuccess) {
          const link = document.createElement('a');
          link.download = 'tarot-result.png';
          link.href = shareImageUrl;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          alert('âœ… ìš´ì„¸ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ê³ \nì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
          sendBehaviorLog('ê³µìœ _ì„±ê³µ_í´ë¦½ë³´ë“œë‹¤ìš´ë¡œë“œ');
        } else {
          alert('ğŸ“‹ ë³µì‚¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ í…ìŠ¤íŠ¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤:\n\n' + shareText);
          sendBehaviorLog('ê³µìœ _ì‹¤íŒ¨_í´ë¦½ë³´ë“œë¶ˆê°€');
        }
        
      } catch (error) {
        console.error('ê³µìœ  ì¤‘ ì˜¤ë¥˜:', error);
        const copySuccess = await copyToClipboard(shareText);
        if (copySuccess) {
          alert('âœ… ìš´ì„¸ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
          sendBehaviorLog('ê³µìœ _ì„±ê³µ_í´ë¦½ë³´ë“œë§Œ');
        } else {
          alert('ğŸ“‹ ê³µìœ  ë‚´ìš©:\n\n' + shareText);
          sendBehaviorLog('ê³µìœ _ì‹¤íŒ¨_ëª¨ë“ ë°©ì‹ì‹¤íŒ¨');
        }
      }
    }

    window.addEventListener('beforeunload', function() {
      if (!hasSelectedCard) {
        sendBehaviorLog('ì¹´ë“œì„ íƒì—†ì´_ì´íƒˆ');
      } else {
        sendBehaviorLog('ì¹´ë“œì„ íƒí›„_ì´íƒˆ');
      }
    });

    // ê°œì„ ëœ ë¡œê·¸ ì „ì†¡ í•¨ìˆ˜
    async function sendBehaviorLog(action) {
      const logData = {
        action: action,
        hasSelectedCard: hasSelectedCard,
        selectedCard: selectedCardName
      };
      
      updateLogStatus('ì „ì†¡ ì¤‘...');
      
      try {
        // ë¨¼ì € no-cors ì—†ì´ ì‹œë„
        const response = await fetch(BEHAVIOR_LOG_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(logData)
        });
        
        const result = await response.text();
        console.log('ë¡œê·¸ ì „ì†¡ ì„±ê³µ:', result);
        updateLogStatus('ì „ì†¡ ì„±ê³µ');
        
      } catch (error) {
        console.log('ì¼ë°˜ ìš”ì²­ ì‹¤íŒ¨, no-corsë¡œ ì¬ì‹œë„:', error);
        
        // CORS ì˜¤ë¥˜ ì‹œ no-corsë¡œ ì¬ì‹œë„
        try {
          await fetch(BEHAVIOR_LOG_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(logData)
          });
          console.log('no-cors ìš”ì²­ ì „ì†¡ ì™„ë£Œ');
          updateLogStatus('ì „ì†¡ ì™„ë£Œ (no-cors)');
        } catch (noCorsError) {
          console.error('ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', noCorsError);
          updateLogStatus('ì „ì†¡ ì‹¤íŒ¨');
        }
      }
    }
  </script>
</body>
</html> 
